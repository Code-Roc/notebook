<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="assets/css/style.css">
    <title>notebook by zjuchenyuan</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>notebook</h1>
        <h2>我的技术笔记本~</h2>

        <section id="downloads">
          
          <a href="http://github.com/zjuchenyuan/notebook" class="btn btn-github"><span class="icon"></span>View on GitHub</a>&nbsp;<a href="https://py3.io" class="btn btn-back"><span class="icon"></span>Back to Index</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="install-">Install 安装</h1>

<p>建议参见<a href="https://github.com/zjuchenyuan/notebook/blob/master/code/ssprivoxy.txt">如何翻墙</a>，部署http proxy</p>

<p>安装之前，建议修改apt源</p>

<p>安装之前，或许要对内核升级，如果执行安装脚本发出了对aufs的警告，请先看下面的 <em>解决aufs的问题</em></p>

<p>安装命令：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -sSL https://get.docker.com/ | sh
</code></pre>
</div>

<p>其中最后一步的apt-get install docker-engine耗时较长，看起来很像卡死，需要耐心等待</p>

<p>安装后执行docker version，没有报错即可</p>

<h2 id="aufs">解决aufs的问题</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>apt-get install lxc wget bsdtar curl
apt-get install linux-image-extra-$(uname -r)
modprobe aufs
</code></pre>
</div>

<hr />

<h1 id="section">加速镜像下载</h1>

<blockquote>
  <p>在执行以下操作之前，请检查docker的版本：<code class="highlighter-rouge">docker -v</code></p>
</blockquote>

<blockquote>
  <p>如果你的docker版本为1.6.2,请参考下方 卸载docker</p>
</blockquote>

<h2 id="ustc">建议使用USTC的源：</h2>

<p>来自：https://lug.ustc.edu.cn/wiki/mirrors/help/docker</p>

<div class="highlighter-rouge"><pre class="highlight"><code>echo '{"registry-mirrors": ["https://docker.mirrors.ustc.edu.cn"]}'&gt;/etc/docker/daemon.json
</code></pre>
</div>

<hr />

<h1 id="docker">Docker旧版本卸载</h1>

<p>如果你的docker是使用apt-get install docker.io安装的，请先执行以下命令卸载：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt-get remove docker.io
apt-get autoremove
rm -rf /var/lib/docker
</code></pre>
</div>

<p>然后就可以执行安装命令了</p>

<hr />

<h2 id="ip">获得容器的ip</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>
docker inspect  --format '{{.NetworkSettings.IPAddress}}' 容器名称

</code></pre>
</div>

<hr />

<h1 id="section-1">导出导入</h1>

<h2 id="export">Export导出容器</h2>

<p>导出容器得到的是tar文件，没有进行压缩，我们需要手动执行压缩</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker export 容器的名称或ID | gzip &gt;导出文件名.tar.gz
</code></pre>
</div>

<h2 id="import">Import导入容器</h2>

<p>虽然上一步我们压缩了，但docker可以直接import，不需要用gunzip</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker import 文件名
</code></pre>
</div>

<hr />

<h1 id="iptables-failed---no-chiantargetmatch-by-that-name">解决iptables failed - No chian/target/match by that name</h1>

<p>如果docker安装的时候没有自动把需要的规则链加上，可以手动添加</p>

<div class="highlighter-rouge"><pre class="highlight"><code>iptables -t nat -N DOCKER
iptables -t filter -N DOCKER
</code></pre>
</div>

<p>附：如果需要删除链条，可以用iptables-save导出后手动编辑后iptables-restore</p>

<hr />

<h1 id="docker-1">迁移Docker文件夹到其他硬盘</h1>

<p>当镜像多了起来的时候，/var/lib所在的磁盘分区很可能被占满，这时候要考虑迁移到其他硬盘，此处以迁移到<code class="highlighter-rouge">/home/docker</code>为例说明</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># 首先记得关闭服务</span>
service docker stop
mv /var/lib/docker /home/
<span class="c"># 然后修改服务配置文件/etc/default/docker，此处建议手动vim编辑，在启动参数中加入这个：</span>
<span class="c">#    --graph='/home/docker'</span>
<span class="nb">echo</span> -e <span class="s2">"</span><span class="se">\n</span><span class="s2">DOCKER_OPTS=</span><span class="se">\"</span><span class="s2">--graph='/home/docker'</span><span class="se">\"</span><span class="s2">"</span> &gt;&gt; /etc/default/docker
</code></pre>
</div>

<hr />

<h1 id="debianifconfigkillall">解决debian等容器没有ifconfig,killall的问题</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>apt-get install net-tools psmisc
</code></pre>
</div>

<hr />

<h1 id="section-2">设置容器低权限用户运行</h1>

<p>在Dockerfile中加入</p>

<div class="highlighter-rouge"><pre class="highlight"><code>User nobody
</code></pre>
</div>

<p>容器运行后exec进去默认是nobody用户，并不能su啥的，这时候exec需要带参数-u表示用指定用户身份进入容器：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker exec -i -t -u root 容器名称 /bin/bash
</code></pre>
</div>

<hr />

<h1 id="etcresolvconfetchosts">设置容器/etc/resolv.conf和/etc/hosts</h1>

<p>在容器中这两个文件是以mount形式挂载的，不能unmount；即使进行修改，容器重启后修改就丢失了</p>

<p>其实这两个文件应该在容器创建的时候指定参数<code class="highlighter-rouge">--dns</code>和<code class="highlighter-rouge">--add-host</code>来加以控制：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run -d --dns 114.114.114.114 --add-host example.com:1.2.3.4 容器名称
</code></pre>
</div>

<hr />

<h1 id="section-3">容器限制参数设置</h1>

<p>当容器是开放给不可信域的时候(如部署一个CTF的pwn题目)，虽然容器逃逸0-day我也没办法，但限制一下容器资源占用防止搅屎也是很有必要的</p>

<div class="highlighter-rouge"><pre class="highlight"><code>--cpu-shares 512 --cpu-period=100000 --cpu-quota=50000 --memory 104857600 --ulimit=nofile=65536 --pids-limit=200 --blkio-weight=512 --restart="always"
</code></pre>
</div>

<p>效果简介：如上配置最多占用 50% 单个 CPU ，最多占用100MB物理内存，容器内进程数目最多200个</p>

<p><code class="highlighter-rouge">--cpu-shares</code>表示相对利用占比，不设置的默认值为1024，单个CPU是1024，只有当容器试图占用100%的CPU时才会体现作用，举个例子：</p>

<blockquote>
  <p>From: http://blog.opskumu.com/docker-cpu-limit.html
假如一个 1core 的主机运行 3 个 container，其中一个 cpu-shares 设置为 1024，而其它 cpu-shares 被设置成 512。当 3 个容器中的进程尝试使用 100% CPU 的时候「尝试使用 100% CPU 很重要，此时才可以体现设置值」，则设置 1024 的容器会占用 50% 的 CPU 时间，其他两个容器则只能分别占用到 25% 的 CPU 时间。
如果主机是 3core，运行 3 个容器，两个 cpu-shares 设置为 512，一个设置为 1024，则此时每个 container 都能占用其中一个 CPU 为 100%。</p>
</blockquote>

<p><code class="highlighter-rouge">--cpu-period</code>表示按多少秒分片，例如设置为100000就是按100ms分割，同时设置<code class="highlighter-rouge">--cpu-quota</code>为50000就是50ms，效果是同时只能使用0.5个CPU</p>

<p><code class="highlighter-rouge">--memory</code>限制容器使用的物理内存，当容器超出时，其中的进程会被kill，详细请参考http://blog.opskumu.com/docker-memory-limit.html</p>

<p><code class="highlighter-rouge">--blkio-weight</code>表示IO相对权重，详细请参考<a href="http://blog.opskumu.com/docker-io-limit.html">http://blog.opskumu.com/docker-io-limit.html</a></p>

      </section>
    </div>

    
  </body>
<script src="https://py3.io/assets/instantclick.min.js"></script><script data-no-instant>InstantClick.init();</script></html>
