<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" href="assets/css/style.css?20170509">
    <title>notebook by zjuchenyuan</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>notebook</h1>
        <h2>我的技术笔记本~</h2>

        <section id="downloads">
          
          <a href="https://github.com/zjuchenyuan/notebook/blob/master/gist.md" class="btn btn-github"><span class="icon"></span>Star me on GitHub (59)</a>&nbsp;<a href="https://py3.io" class="btn btn-back"><span class="icon"></span>Back to Index</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="gist-">gist 记录一些代码片段</h1>

<ul id="markdown-toc">
  <li><a href="#gist-" id="markdown-toc-gist-">gist 记录一些代码片段</a>    <ul>
      <li><a href="#mysql" id="markdown-toc-mysql">连接mysql批量插入、查询</a></li>
      <li><a href="#flask" id="markdown-toc-flask">flask设置一堆静态目录</a></li>
      <li><a href="#section" id="markdown-toc-section">大小写不敏感字典</a></li>
      <li><a href="#print" id="markdown-toc-print">print的时候顺带带上时间</a></li>
      <li><a href="#mpms" id="markdown-toc-mpms">mpms多线程下每个线程单独变量</a></li>
    </ul>
  </li>
</ul>

<h2 id="mysql">连接mysql批量插入、查询</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">def</span> <span class="nf">db</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">'root'</span><span class="p">,</span><span class="n">passwd</span><span class="o">=</span><span class="s">'123456'</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="s">'dbname'</span><span class="p">,</span><span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">,</span><span class="n">init_command</span><span class="o">=</span><span class="s">"set NAMES utf8mb4"</span><span class="p">,</span> <span class="n">use_unicode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">"utf8"</span>
    <span class="k">return</span> <span class="n">conn</span>
<span class="n">conn</span><span class="o">=</span><span class="n">db</span><span class="p">()</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="c"># 批量插入 将list转为一条sql语句执行insert</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into TABLENAME values"</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="o">...</span><span class="p">:</span>
    <span class="n">sql</span> <span class="o">+=</span> <span class="s">"('"</span><span class="o">+</span><span class="s">"','"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pymysql</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span><span class="o">+</span><span class="s">"'),"</span>
<span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Error SQL: "</span><span class="o">+</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># 显示出错的SQL语句后稍作等待，也方便Ctrl+C</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c"># 查一条，返回一个dict</span>
<span class="nb">id</span> <span class="o">=</span> <span class="o">...</span> <span class="c">#id为主键 只会有一条记录</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"select * from tablename where id="</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s">"id"</span><span class="p">,</span><span class="s">"flag"</span><span class="p">,</span><span class="s">"更多的列名"</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">cur</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre>
</div>

<h2 id="flask">flask设置一堆静态目录</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Markup</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'pic'</span><span class="p">,</span> <span class="s">'skin'</span><span class="p">,</span> <span class="s">'images'</span><span class="p">,</span> <span class="s">'更多静态目录'</span><span class="p">]:</span>
    <span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">__name__</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s">'/'</span><span class="o">+</span><span class="n">path</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">blueprint</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="section">大小写不敏感字典</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">requests.structures</span> <span class="kn">import</span> <span class="n">CaseInsensitiveDict</span>
<span class="n">mydict</span> <span class="o">=</span> <span class="n">CaseInsensitiveDict</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="print">print的时候顺带带上时间</h2>

<p>使用这种方式的好处不仅是显示时间，而且可以很方便地将往屏幕输出改为写文件；更优雅的方式是用logging</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="n">myprint</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"[{showtime}] {s}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">showtime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S"</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>

<span class="n">myprint</span><span class="p">(</span><span class="s">"aha myprint"</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="mpms">mpms多线程下每个线程单独变量</h2>

<p>自己写的类不是线程安全的，所以在多线程下要做到每个线程自己一个变量互不干扰</p>

<p>mpms下使用EasyLogin完整示例代码模板， 先要使用我fork的版本 加上了len支持：</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>wget https://d.py3.io/mpms.py
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">mpms</span> <span class="kn">import</span> <span class="n">MPMS</span>
<span class="kn">from</span> <span class="nn">EasyLogin</span> <span class="kn">import</span> <span class="n">EasyLogin</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="n">thread_data</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">myprint</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"[{showtime}] {s}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">showtime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S"</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">thread_data</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">thread_data</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"a"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">EasyLogin</span><span class="p">()</span>
        <span class="n">thread_data</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">"a"</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">pass</span> <span class="c"># do the stuff, like a.get</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="c"># meta["fp"].write ...</span>
    <span class="k">pass</span> <span class="c"># do the stuff</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s">"fp"</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s">"result.txt"</span><span class="p">,</span><span class="s">"w"</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)}</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">MPMS</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">m</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">myprint</span><span class="p">(</span><span class="s">"Remaning "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">myprint</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">)</span>
</code></pre>
</div>

      </section>
<br><hr><h1 id="comment">评论区</h1><div id="comment-thread"></div><div id="loading-spin"></div>
    </div>

  </body>
<script src="assets/js/instantclick.min.js" data-no-instant></script>
<link rel="stylesheet" href="assets/css/comment.css">
<script src="assets/js/comment.js" data-no-instant></script>
<script>
  marked.setOptions({
  highlight: function (code, lang) {
     return hljs.highlightAuto(code).value;
  }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
       if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
   var opt = {
       type: "github",
       user: "zjuchenyuan",
       repo: "notebook",
       no_comment: "No comments yet. Press the button and go to comment now!",
       go_to_comment: "Go to comment",
       issue_id: "1",
       btn_class: "btn",
       comments_target: "#comment-thread",
       loading_target: "#loading-spin",
       client_id: "8f7a792630aa459d0812",
       client_secret: "084b314f30dd9b10201011e265c4cb5d78c2b2e9"
   };
   if (jQuery('.discussion-timeline').length == 0) getComments(opt);
</script>
<script data-no-instant>
  InstantClick.init();
</script>
</html>
